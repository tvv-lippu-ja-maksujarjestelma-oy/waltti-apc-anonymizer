// FIXME: not needed now
// import csvParseSync from "csv-parse/sync";
import pino from "pino";
import { createProfileMap } from "./vehicleProfile";
import { VehicleProfileMap } from "./types";

test("Simple CSV", () => {
  const logger = pino(
    {
      name: "waltti-apc-anonymizer-tests",
      timestamp: pino.stdTimeFunctions.isoTime,
      level: "debug",
    },
    pino.destination({ sync: true }),
  );
  const collection = {
    vehicleModels: {
      "fi:kuopio:1234_567": "49-77",
    },
    modelProfiles: {
      "49-77":
        "passenger_count,EMPTY,FEW_SEATS_AVAILABLE,FULL\n0,0.5,0.5,0.0\n1,0.0,0.5,0.5",
    },
  };
  const expectedMap: VehicleProfileMap = {
    vehicleModels: new Map([["fi:kuopio:1234_567", "49-77"]]),
    modelProfiles: new Map([
      [
        "49-77",
        {
          categories: ["EMPTY", "FEW_SEATS_AVAILABLE", "FULL"],
          cdf: [
            new Float64Array([0.5, 1.0, 1.0]),
            new Float64Array([0, 0.5, 1.0]),
          ],
        },
      ],
    ]),
  };
  expect(createProfileMap(logger, collection)).toStrictEqual(expectedMap);
});

/* eslint-disable jest/no-commented-out-tests */
// // FIXME: remove
// describe("CSV parsing errors", () => {
//   test("header too long", () => {
//     const csvString = `
// passenger_count,EMPTY,MANY_SEATS_AVAILABLE,FEW_SEATS_AVAILABLE
// 0,0.9977371692657471,0.002262833761051297
// 1,0.9944344758987427,0.005565507803112268
// 2,0.9851734042167664,0.01482658367604017
// 3,0.9610946178436279,0.03890539705753326
// `.trim();
//     const records = csvParseSync.parse(csvString, { cast: true });
//     console.log(records);
//     expect(1).toBe(2);
//   });
//
//   test("header too short", () => {
//     const csvString = `
// passenger_count,EMPTY
// 0,0.9977371692657471,0.002262833761051297
// 1,0.9944344758987427,0.005565507803112268
// 2,0.9851734042167664,0.01482658367604017
// 3,0.9610946178436279,0.03890539705753326
// `.trim();
//     const records = csvParseSync.parse(csvString, { cast: true });
//     console.log(records);
//     expect(1).toBe(2);
//   });
//
//   test("data row is too short", () => {
//     const csvString = `
// passenger_count,EMPTY,MANY_SEATS_AVAILABLE
// 0,0.9977371692657471,0.002262833761051297
// 1,0.9944344758987427
// 2,0.9851734042167664,0.01482658367604017
// 3,0.9610946178436279,0.03890539705753326
// `.trim();
//     const records = csvParseSync.parse(csvString, { cast: true });
//     console.log(records);
//     expect(1).toBe(2);
//   });
//
//   test("data has missing value", () => {
//     const csvString = `
// passenger_count,EMPTY,MANY_SEATS_AVAILABLE
// 0,0.9977371692657471,0.002262833761051297
// 1,0.9944344758987427,
// 2,0.9851734042167664,0.01482658367604017
// 3,0.9610946178436279,0.03890539705753326
// `.trim();
//     const records = csvParseSync.parse(csvString, { cast: true });
//     console.log(records);
//     expect(1).toBe(2);
//   });
//
//   test("data has null", () => {
//     const csvString = `
// passenger_count,EMPTY,MANY_SEATS_AVAILABLE
// 0,0.9977371692657471,0.002262833761051297
// 1,0.9944344758987427,null
// 2,0.9851734042167664,0.01482658367604017
// 3,0.9610946178436279,0.03890539705753326
// `.trim();
//     const records = csvParseSync.parse(csvString, { cast: true });
//     console.log(records);
//     expect(1).toBe(2);
//   });
//
//   test("data has undefined", () => {
//     const csvString = `
// passenger_count,EMPTY,MANY_SEATS_AVAILABLE
// 0,0.9977371692657471,0.002262833761051297
// 1,0.9944344758987427,undefined
// 2,0.9851734042167664,0.01482658367604017
// 3,0.9610946178436279,0.03890539705753326
// `.trim();
//     const records = csvParseSync.parse(csvString, { cast: true });
//     console.log(records);
//     expect(1).toBe(2);
//   });
//
//   test("data has Infinity", () => {
//     const csvString = `
// passenger_count,EMPTY,MANY_SEATS_AVAILABLE
// 0,0.9977371692657471,0.002262833761051297
// 1,0.9944344758987427,Inf
// 2,0.9851734042167664,Infinity
// 3,0.9610946178436279,0.03890539705753326
// `.trim();
//     const records = csvParseSync.parse(csvString, { cast: true });
//     console.log(records);
//     expect(1).toBe(2);
//   });
//
//   test("data has NaN", () => {
//     const csvString = `
// passenger_count,EMPTY,MANY_SEATS_AVAILABLE
// 0,0.9977371692657471,0.002262833761051297
// 1,0.9944344758987427,NaN
// 2,0.9851734042167664,0.01482658367604017
// 3,0.9610946178436279,0.03890539705753326
// `.trim();
//     const records = csvParseSync.parse(csvString, { cast: true });
//     console.log(records);
//     expect(1).toBe(2);
//   });
//
//   test("CSV parsing realistic", () => {
//     const csvString = `
// passenger_count,EMPTY,MANY_SEATS_AVAILABLE,FEW_SEATS_AVAILABLE,STANDING_ROOM_ONLY,CRUSHED_STANDING_ROOM_ONLY,FULL
// 0,0.9977371692657471,0.002262833761051297,0,0,0,0
// 1,0.9944344758987427,0.005565507803112268,0,0,0,0
// 2,0.9851734042167664,0.01482658367604017,0,0,0,0
// 3,0.9610946178436279,0.03890539705753326,0,0,0,0
// 4,0.8984706401824951,0.1015294119715691,0,0,0,0
// 5,0.7252665162086487,0.2747334837913513,0,0,0,0
// 6,0.2750506699085236,0.7249493598937988,0,0,0,0
// 7,0.1034820973873138,0.8965178728103638,0,0,0,0
// 8,0.03864414989948273,0.9613558053970337,0,0,0,0
// 9,0.01428575441241264,0.9857142567634583,0,0,0,0
// 10,0.005324557889252901,0.9946753978729248,0,0,0,0
// 11,0.001994613790884614,0.9980053901672363,0,0,0,0
// 12,0.0007355268462561071,0.9992644190788269,0,0,0,0
// 13,0.0002708928659558296,0.9997290968894958,0,0,0,0
// 14,0.0001002353310468607,0.9998997449874878,0,0,0,0
// 15,3.43934225384146e-05,0.9999655485153198,0,0,0,0
// 16,9.400793715030886e-06,0.9999905824661255,0,0,0,0
// 17,0,1,0,0,0,0
// 18,0,1,0,0,0,0
// 19,0,1,0,0,0,0
// 20,0,1,0,0,0,0
// 21,0,1,0,0,0,0
// 22,0,1,0,0,0,0
// 23,0,1,0,0,0,0
// 24,0,1,0,0,0,0
// 25,0,0.9999901056289673,9.907720595947467e-06,0,0,0
// 26,0,0.9999637007713318,3.629337879829109e-05,0,0,0
// 27,0,0.9998944997787476,0.0001054728054441512,0,0,0
// 28,0,0.9997082352638245,0.0002917063829954714,0,0,0
// 29,0,0.9992072582244873,0.0007927245460450649,0,0,0
// 30,0,0.9978508353233337,0.002149156760424376,0,0,0
// 31,0,0.9943948984146118,0.005605080164968967,0,0,0
// 32,0,0.9857654571533203,0.01423453073948622,0,0,0
// 33,0,0.9613940119743347,0.03860597312450409,0,0,0
// 34,0,0.8979303240776062,0.1020696982741356,0,0,0
// 35,0,0.7265309691429138,0.2734591960906982,9.799256986298133e-06,0,0
// 36,0,0.2735384106636047,0.7264254689216614,3.612510408856906e-05,0,0
// 37,0,0.1040301322937012,0.8958624005317688,0.0001074445390258916,0,0
// 38,0,0.04000474885106087,0.9596972465515137,0.0002980041317641735,0,0
// 39,0,0.01561175193637609,0.983583390712738,0.0008048021118156612,0,0
// 40,0,0.00591391185298562,0.9919497966766357,0.002136275172233582,0,0
// 41,0,0.002232279861345887,0.9922336339950562,0.005534105002880096,0,0
// 42,0,0.0008236590074375272,0.9848596453666687,0.01431668642908335,0,0
// 43,0,0.0003055073029827327,0.9609969854354858,0.038697499781847,0,0
// 44,0,0.0001094194376491942,0.8994197845458984,0.1004708036780357,0,0
// 45,0,3.681984526338056e-05,0.7283013463020325,0.271661788225174,0,0
// 46,0,9.946374120772816e-06,0.2706743180751801,0.7293156981468201,0,0
// 47,0,0,0.1048017963767052,0.8951982259750366,0,0
// 48,0,0,0.03908373787999153,0.96091628074646,0,0
// 49,0,0,0.0146403256803751,0.9853597283363342,0,0
// 50,0,0,0.005487428978085518,0.9945125579833984,0,0
// 51,0,0,0.002104645362123847,0.997895359992981,0,0
// 52,0,0,0.0007782839820720255,0.9992216825485229,0,0
// 53,0,0,0.0002836250059772283,0.9997163414955139,0,0
// 54,0,0,0.0001047959012794308,0.9998952150344849,0,0
// 55,0,0,3.629753337008879e-05,0.9999637007713318,0,0
// 56,0,0,9.696836059447378e-06,0.9999902844429016,0,0
// 57,0,0,0,1,0,0
// 58,0,0,0,1,0,0
// 59,0,0,0,1,0,0
// 60,0,0,0,1,0,0
// 61,0,0,0,1,0,0
// 62,0,0,0,1,0,0
// 63,0,0,0,1,0,0
// 64,0,0,0,1,0,0
// 65,0,0,0,1,0,0
// 66,0,0,0,1,0,0
// 67,0,0,0,1,0,0
// 68,0,0,0,0.9999902248382568,9.769012649485376e-06,0
// 69,0,0,0,0.9999634623527527,3.653033854789101e-05,0
// 70,0,0,0,0.999891996383667,0.0001080277215805836,0
// 71,0,0,0,0.9997037053108215,0.0002963106089737266,0
// 72,0,0,0,0.9991918802261353,0.0008081155247054994,0
// 73,0,0,0,0.9978870153427124,0.002112960675731301,0
// 74,0,0,0,0.9945629835128784,0.005437020678073168,0
// 75,0,0,0,0.9852365255355835,0.01476346701383591,0
// 76,0,0,0,0.9600870609283447,0.03991295024752617,0
// 77,0,0,0,0.8958183526992798,0.1041816100478172,0
// 78,0,0,0,0.7322152256965637,0.2677848041057587,0
// 79,0,0,0,0.2721015512943268,0.7278984785079956,0
// 80,0,0,0,0.1003100350499153,0.8996899127960205,0
// 81,0,0,0,0.03908735513687134,0.9609126448631287,0
// 82,0,0,0,0.01523950882256031,0.9847604632377625,0
// 83,0,0,0,0.005688441917300224,0.9943115711212158,0
// 84,0,0,0,0.002127987332642078,0.997871994972229,0
// 85,0,0,0,0.000779877242166549,0.9992201328277588,0
// 86,0,0,0,0.0002926322631537914,0.9997073411941528,0
// 87,0,0,0,0.0001064054158632644,0.9998935461044312,0
// 88,0,0,0,3.597416070988402e-05,0.9999639987945557,0
// 89,0,0,0,9.879039680527057e-06,0.9999901056289673,0
// 90,0,0,0,0,1,0
// 91,0,0,0,0,1,0
// 92,0,0,0,0,0.9999902844429016,9.710161975817755e-06
// 93,0,0,0,0,0.9999641180038452,3.590972482925281e-05
// 94,0,0,0,0,0.9998925924301147,0.0001073499661288224
// 95,0,0,0,0,0.9997023940086365,0.0002976146643050015
// 96,0,0,0,0,0.9991992712020874,0.0008007131982594728
// 97,0,0,0,0,0.9978753328323364,0.002124659717082977
// 98,0,0,0,0,0.9944168329238892,0.005583119578659534
// 99,0,0,0,0,0.984857976436615,0.01514201611280441
// 100,0,0,0,0,0.9612783193588257,0.03872167691588402
// 101,0,0,0,0,0.895546555519104,0.1044534370303154
// 102,0,0,0,0,0.7219098210334778,0.2780902087688446
// 103,0,0,0,0,0.27948197722435,0.7205180525779724
// 104,0,0,0,0,0.1029079556465149,0.8970920443534851
// 105,0,0,0,0,0.03915858641266823,0.9608414173126221
// 106,0,0,0,0,0.01491925958544016,0.9850807189941406
// 107,0,0,0,0,0.005712901707738638,0.9942870736122131
// 108,0,0,0,0,0.002102954778820276,0.9978970289230347
// 109,0,0,0,0,0.0007987249409779906,0.999201238155365
// 110,0,0,0,0,0.0002942016581073403,0.9997058510780334
// 111,0,0,0,0,0.0001074331303243525,0.9998925924301147
// 112,0,0,0,0,3.598870898713358e-05,0.9999639987945557
// 113,0,0,0,0,9.661095646151807e-06,0.9999903440475464
// 114,0,0,0,0,0,1
// 115,0,0,0,0,0,1
// 116,0,0,0,0,0,1
// 117,0,0,0,0,0,1
//   `.trim();
//     const records = csvParseSync.parse(csvString, { cast: true });
//     console.log(records);
//     expect(1).toBe(2);
//   });
// });
//
/* eslint-enable jest/no-commented-out-tests */
